<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>空中文字ドット表示</title>
<style>
  body { background: #000; color: #fff; text-align: center; margin:0; padding:0; }
  #inputScreen, #displayScreen {
    position: absolute; top:0; left:0; width:100%; height:100%;
    display:flex; justify-content:center; align-items:center; flex-direction:column;
  }
  #displayScreen { display:none; }
  canvas { background:#000; }
</style>
</head>
<body>

<!-- 入力画面 -->
<div id="inputScreen">
  <input type="text" id="textInput" placeholder="文字を入力" value="HELLO WORLD">
  <button id="runBtn">表示</button>
</div>

<!-- 表示画面 -->
<div id="displayScreen">
  <canvas id="dotCanvas" width="600" height="144"></canvas>
  <p style="color:white;font-size:0.8em;">画面をタップすると入力画面に戻る</p>
</div>

<canvas id="textCanvas" width="1000" height="200" style="display:none;"></canvas>

<script>
const inputScreen = document.getElementById('inputScreen');
const displayScreen = document.getElementById('displayScreen');
const runBtn = document.getElementById('runBtn');
const dotCanvas = document.getElementById('dotCanvas');
const dctx = dotCanvas.getContext('2d');
const textCanvas = document.getElementById('textCanvas');
const tctx = textCanvas.getContext('2d');

let matrix = [];
let colIndex = 0;
let direction = 1;
let lastAcc = {x:0, y:0, z:0};
const threshold = 12;
const scale = 6; // ドット1つのサイズ

function textToDotMatrix(text, height=24, maxWidth=500){
  tctx.clearRect(0,0,textCanvas.width,textCanvas.height);
  tctx.fillStyle="black";
  tctx.fillRect(0,0,textCanvas.width,textCanvas.height);
  tctx.fillStyle="white";
  tctx.font="bold 120px sans-serif";
  tctx.textAlign="left";
  tctx.textBaseline="top";
  tctx.fillText(text,20,20);

  const textWidth = tctx.measureText(text).width + 40;
  const width = Math.min(maxWidth, Math.floor(textWidth*(height/textCanvas.height)));

  const smallCanvas = document.createElement("canvas");
  smallCanvas.width = width;
  smallCanvas.height = height;
  const sctx = smallCanvas.getContext("2d");
  sctx.drawImage(textCanvas,0,0,width,height);

  const imgData = sctx.getImageData(0,0,width,height);
  const pixels = imgData.data;
  const dotMatrix = [];
  for(let y=0;y<height;y++){
    const row = [];
    for(let x=0;x<width;x++){
      const i = (y*width+x)*4;
      const r=pixels[i],g=pixels[i+1],b=pixels[i+2];
      const brightness=(r+g+b)/3;
      row.push(brightness>128?1:0);
    }
    dotMatrix.push(row);
  }
  return dotMatrix;
}

function drawColumn(index){
  dctx.clearRect(0,0,dotCanvas.width,dotCanvas.height);
  const width = matrix[0].length;
  const height = matrix.length;
  for(let y=0;y<height;y++){
    for(let x=0;x<width;x++){
      if(x===index && matrix[y][x]){
        dctx.fillStyle="lime";
        dctx.fillRect(x*scale,y*scale,scale,scale);
      }
    }
  }
  colIndex += direction;
  if(colIndex>=matrix[0].length){direction=-1; colIndex=matrix[0].length-1;}
  if(colIndex<0){direction=1; colIndex=0;}
}

runBtn.addEventListener('click',()=>{
  const text = document.getElementById('textInput').value || "HELLO";
  matrix = textToDotMatrix(text);
  colIndex = 0; direction=1;
  inputScreen.style.display="none";
  displayScreen.style.display="flex";
  drawColumn(colIndex);
});

// 画面タップで入力画面に戻る
displayScreen.addEventListener('click',()=>{
  displayScreen.style.display="none";
  inputScreen.style.display="flex";
});


// 横方向の加速度で列送り
function handleMotion(event){
  const acc = event.accelerationIncludingGravity;
  if(!acc) return;
  const now = Date.now();
  if(now - lastTime < 100) return; // 連打防止
  const ax = acc.x;

  if(ax > threshold){
    colIndex++;
    if(colIndex >= WIDTH) colIndex = WIDTH - 1;
    drawColumn(colIndex);
    lastTime = now;
  } else if(ax < -threshold){
    colIndex--;
    if(colIndex < 0) colIndex = 0;
    drawColumn(colIndex);
    lastTime = now;
  }
}


// iOS対応
if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
  DeviceMotionEvent.requestPermission()
    .then(resp=>{if(resp==='granted'){window.addEventListener('devicemotion',handleMotion);}else{alert("加速度センサーの許可が必要です");}})
    .catch(console.error);
}else{
  window.addEventListener('devicemotion',handleMotion);
}
</script>
</body>
</html>
