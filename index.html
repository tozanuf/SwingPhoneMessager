<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>空中文字表示</title>
<style>
  html, body {
    margin:0; padding:0; background:#000; color:#fff; width:100%; height:100%;
    display:flex; justify-content:center; align-items:center; overflow:hidden;
  }
  #inputScreen, #displayScreen {
    position:absolute; top:0; left:0; width:100%; height:100%;
    display:flex; justify-content:center; align-items:center; flex-direction:column;
  }
  #displayScreen { display:none; }
  canvas { background:#000; display:block; }
  input { font-size:1.2em; padding:0.5em; }
  button { font-size:1.2em; padding:0.5em 1em; margin-top:0.5em; }
</style>
</head>
<body>

<!-- 入力画面 -->
<div id="inputScreen">
  <input type="text" id="textInput" placeholder="文字を入力" value="HELLO WORLD">
  <button id="runBtn">表示</button>
</div>

<!-- 表示画面 -->
<div id="displayScreen">
  <canvas id="dotCanvas"></canvas>
</div>

<!-- 非表示キャンバスで文字列をドット化 -->
<canvas id="textCanvas" width="1000" height="200" style="display:none;"></canvas>

<script>
const inputScreen = document.getElementById('inputScreen');
const displayScreen = document.getElementById('displayScreen');
const runBtn = document.getElementById('runBtn');
const dotCanvas = document.getElementById('dotCanvas');
const dctx = dotCanvas.getContext('2d');
const textCanvas = document.getElementById('textCanvas');
const tctx = textCanvas.getContext('2d');

let matrix = [];
let colIndex = 0;
let scale = 10; // 後で画面縦サイズに合わせて自動計算
let intervalId = null;

// 文字列→24×Nドットマトリクス
function textToDotMatrix(text, height=24, maxWidth=500){
  tctx.clearRect(0,0,textCanvas.width,textCanvas.height);
  tctx.fillStyle="black";
  tctx.fillRect(0,0,textCanvas.width,textCanvas.height);
  tctx.fillStyle="white";
  tctx.font="bold 120px sans-serif";
  tctx.textAlign="left";
  tctx.textBaseline="top";
  tctx.fillText(text,20,20);

  const textWidth = tctx.measureText(text).width + 40;
  const width = Math.min(maxWidth, Math.floor(textWidth*(height/textCanvas.height)));

  const smallCanvas = document.createElement("canvas");
  smallCanvas.width = width;
  smallCanvas.height = height;
  const sctx = smallCanvas.getContext("2d");
  sctx.drawImage(textCanvas,0,0,width,height);

  const imgData = sctx.getImageData(0,0,width,height);
  const pixels = imgData.data;
  const dotMatrix = [];
  for(let y=0;y<height;y++){
    const row = [];
    for(let x=0;x<width;x++){
      const i = (y*width+x)*4;
      const r=pixels[i],g=pixels[i+1],b=pixels[i+2];
      const brightness=(r+g+b)/3;
      row.push(brightness>128?1:0);
    }
    dotMatrix.push(row);
  }
  return dotMatrix;
}

// 1列描画
function drawColumn(index){
  dctx.fillStyle = "black";
  dctx.fillRect(0,0,dotCanvas.width,dotCanvas.height);
  const height = matrix.length;
  const width = matrix[0].length;

  for(let y=0;y<height;y++){
    if(matrix[y][index]){
      dctx.fillStyle="lime";
      dctx.fillRect(index*scale, y*scale, scale, scale);
    }
  }
}

// 列自動送り
function autoScroll(){
  colIndex++;
  if(colIndex >= matrix[0].length) colIndex = 0;
  drawColumn(colIndex);
}

// 表示開始
runBtn.addEventListener('click',()=>{
  const text = document.getElementById('textInput').value || "HELLO";
  matrix = textToDotMatrix(text);

  // 画面縦いっぱいにスケール自動計算
  scale = Math.floor(dotCanvas.clientHeight / matrix.length);
  dotCanvas.width = matrix[0].length * scale;
  dotCanvas.height = matrix.length * scale;

  colIndex = 0;
  inputScreen.style.display="none";
  displayScreen.style.display="flex";

  drawColumn(colIndex);

  if(intervalId) clearInterval(intervalId);
  intervalId = setInterval(autoScroll, 100); // 100msごとに列送り
});

// 画面タップで入力画面に戻る
displayScreen.addEventListener('click',()=>{
  displayScreen.style.display="none";
  inputScreen.style.display="flex";
  if(intervalId) clearInterval(intervalId);
});
</script>
</body>
</html>
